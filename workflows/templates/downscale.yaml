apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: downscale
  labels:
    component: downscale
spec:
  workflowMetadata:
    labels:
      component: downscale
  parallelism: 300
  entrypoint: downscale
  arguments:
    parameters:
      - name: variable-id
        value: "tasmin"
      - name: source-id
        value: "GFDL-ESM4"
      - name: historical
        value: |
          [
            { "activity-id": "CMIP", "experiment-id": "historical", "table-id": "day", "variable-id": "tasmin", "source-id": "GFDL-ESM4", "institution-id": "NOAA-GFDL", "member-id": "r1i1p1f1", "grid-label": "gr1", "version": "20190726" }
          ]
      - name: ssps
        value: |
          [
            { "activity-id": "ScenarioMIP", "experiment-id": "ssp370", "table-id": "day", "variable-id": "tasmin", "source-id": "GFDL-ESM4", "institution-id": "NOAA-GFDL", "member-id": "r1i1p1f1", "grid-label": "gr1", "version": "20180701" },
            { "activity-id": "ScenarioMIP", "experiment-id": "ssp245", "table-id": "day", "variable-id": "tasmin", "source-id": "GFDL-ESM4", "institution-id": "NOAA-GFDL", "member-id": "r1i1p1f1", "grid-label": "gr1", "version": "20180701" },
            { "activity-id": "ScenarioMIP", "experiment-id": "ssp126", "table-id": "day", "variable-id": "tasmin", "source-id": "GFDL-ESM4", "institution-id": "NOAA-GFDL", "member-id": "r1i1p1f1", "grid-label": "gr1", "version": "20180701" }
          ]

      - name: qdm-kind #additive or multiplicative
        value: "additive"
      - name: regrid-method
        value: "bilinear"
      - name: correct-wetday-frequency
        value: "false"
  templates:


    - name: downscale
      inputs:
        parameters:
          - name: variable-id
          - name: historical
          - name: ssps
          - name: regrid-method
          - name: qdm-kind
          - name: correct-wetday-frequency
          - name: domainfile1x1
            value: "az://support/domain.1x1.zarr"
          - name: domainfile0p25x0p25
            value: "az://support/domain.0p25x0p25.zarr"
          - name: reference-zarr
            value: "az://clean-era5/F320/{{ inputs.parameters.variable-id }}.1995-2015.F320.zarr"
      steps:
        - - name: create-fine-reference
            template: create-fine-reference
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ inputs.parameters.reference-zarr }}"
                - name: regrid-method
                  value: "{{ inputs.parameters.regrid-method }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domainfile0p25x0p25 }}"
          - name: create-coarse-reference
            template: create-coarse-reference
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ inputs.parameters.reference-zarr }}"
                - name: regrid-method
                  value: "{{ inputs.parameters.regrid-method }}"
                - name: domainfile0p25x0p25
                  value: "{{ inputs.parameters.domainfile0p25x0p25 }}"
                - name: domainfile1x1
                  value: "{{ inputs.parameters.domainfile1x1 }}"
        - - name: downscale-historical
            template: downscale-simulation
            arguments:
              parameters:
                - name: experiment-id
                  value: "{{ item.experiment-id }}"
                - name: activity-id
                  value: "{{ item.activity-id }}"
                - name: table-id
                  value: "{{ item.table-id }}"
                - name: variable-id
                  value: "{{ item.variable-id }}"
                - name: source-id
                  value: "{{ item.source-id }}"
                - name: institution-id
                  value: "{{ item.institution-id }}"
                - name: member-id
                  value: "{{ item.member-id }}"
                - name: grid-label
                  value: "{{ item.grid-label }}"
                - name: version
                  value: "000000000000"
                - name: coarse-reference-zarr
                  value: "{{ steps.create-coarse-reference.outputs.parameters.out-zarr }}"
                - name: fine-reference-zarr
                  value: "{{ steps.create-fine-reference.outputs.parameters.out-zarr }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domainfile0p25x0p25 }}"
                - name: qdm-kind
                  value: "{{ inputs.parameters.qdm-kind }}"
            withParam: "{{ inputs.parameters.historical }}"
          - name: downscale-ssps
            template: downscale-simulation
            arguments:
              parameters:
                - name: experiment-id
                  value: "{{ item.experiment-id }}"
                - name: activity-id
                  value: "{{ item.activity-id }}"
                - name: table-id
                  value: "{{ item.table-id }}"
                - name: variable-id
                  value: "{{ item.variable-id }}"
                - name: source-id
                  value: "{{ item.source-id }}"
                - name: institution-id
                  value: "{{ item.institution-id }}"
                - name: member-id
                  value: "{{ item.member-id }}"
                - name: grid-label
                  value: "{{ item.grid-label }}"
                - name: version
                  value: "000000000000"
                - name: coarse-reference-zarr
                  value: "{{ steps.create-coarse-reference.outputs.parameters.out-zarr }}"
                - name: fine-reference-zarr
                  value: "{{ steps.create-fine-reference.outputs.parameters.out-zarr }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domainfile0p25x0p25 }}"
                - name: qdm-kind
                  value: "{{ inputs.parameters.qdm-kind }}"
            withParam: "{{ inputs.parameters.ssps }}"


    - name: downscale-simulation
      inputs:
        parameters:
          - name: experiment-id
          - name: activity-id
          - name: table-id
          - name: variable-id
          - name: source-id
          - name: institution-id
          - name: member-id
          - name: grid-label
          - name: version
            value: "000000000000"
          - name: domain-file
          - name: qdm-kind
          - name: coarse-reference-zarr
          - name: fine-reference-zarr
      steps:
        - - name: infer-biascorrected-output-url
            templateRef:
              name: catalog
              template: get-fsspec-url-from-parameters
            arguments:
              parameters:
                - name: experiment-id
                  value: "{{ inputs.parameters.experiment-id }}"
                - name: activity-id
                  value: "{{ inputs.parameters.activity-id }}"
                - name: table-id
                  value: "{{ inputs.parameters.table-id }}"
                - name: variable-id
                  value: "{{ inputs.parameters.variable-id }}"
                - name: source-id
                  value: "{{ inputs.parameters.source-id }}"
                - name: institution-id
                  value: "{{ inputs.parameters.institution-id }}"
                - name: member-id
                  value: "{{ inputs.parameters.member-id }}"
                - name: grid-label
                  value: "{{ inputs.parameters.grid-label }}"
                - name: version
                  value: "{{ inputs.parameters.version }}"
                - name: base-url
                  value: "az://biascorrected-stage"
          - name: infer-downscaled-output-url
            templateRef:
              name: catalog
              template: get-fsspec-url-from-parameters
            arguments:
              parameters:
                - name: experiment-id
                  value: "{{ inputs.parameters.experiment-id }}"
                - name: activity-id
                  value: "{{ inputs.parameters.activity-id }}"
                - name: table-id
                  value: "{{ inputs.parameters.table-id }}"
                - name: variable-id
                  value: "{{ inputs.parameters.variable-id }}"
                - name: source-id
                  value: "{{ inputs.parameters.source-id }}"
                - name: institution-id
                  value: "{{ inputs.parameters.institution-id }}"
                - name: member-id
                  value: "{{ inputs.parameters.member-id }}"
                - name: grid-label
                  value: "{{ inputs.parameters.grid-label }}"
                - name: version
                  value: "{{ inputs.parameters.version }}"
                - name: base-url
                  value: "as://downscaled-stage"
        - - name: preprocess-biascorrected
            template: preprocess-biascorrected
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ steps.infer-biascorrected-output-url.outputs.parameters.out-url }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domain-file }}"
        - - name: prime-aiqpd-biascorrected-output-zarr
            template: prime-aiqpd-biascorrected-output-zarr
            arguments:
              parameters:
                - name: simulation-zarr
                  value: "{{ steps.preprocess-biascorrected.outputs.parameters.out-zarr }}"
                - name: variable
                  value: "{{ inputs.parameters.variable-id }}"
        - - name: aiqpd
            template: aiqpd
            arguments:
              parameters:
                - name: variable-id
                  value: "{{ inputs.parameters.variable-id }}"
                - name: simulation-zarr
                  value: "{{ steps.preprocess-biascorrected.outputs.parameters.out-zarr }}"
                - name: coarse-reference-zarr
                  value: "{{ inputs.parameters.coarse-reference-zarr }}"
                - name: fine-reference-zarr
                  value: "{{ inputs.parameters.fine-reference-zarr }}"
                - name: qdm-kind
                  value: "{{ inputs.parameters.qdm-kind }}"
                - name: out-zarr
                  value: "{{ steps.prime-aiqpd-biascorrected-output-zarr.outputs.parameters.out-zarr }}"
                - name: lat-slice-min
                  value: "{{=asInt(item) * 2 }}"
                - name: lat-slice-max
                  value: "{{=asInt(item) * 2 + 2 }}"
            withSequence:
              start: "0"
              end: "359"


    - name: aiqpd
      inputs:
        parameters:
          - name: simulation-zarr
          - name: coarse-reference-zarr
          - name: fine-reference-zarr
          - name: variable-id
          - name: qdm-kind
          - name: lat-slice-min
          - name: lat-slice-max
          - name: out-zarr
      outputs:
        parameters:
          - name: out-zarr
            value: "{{ inputs.parameters.out-zarr }}"
      steps:
        - - name: train-downscaling-model
            template: train-aiqpd
            arguments:
              parameters:
                - name: variable-id
                  value: "{{ inputs.parameters.variable-id }}"
                - name: coarse-reference-zarr
                  value: "{{ steps.create-coarse-reference.outputs.parameters.out-zarr }}"
                - name: fine-reference-zarr
                  value: "{{ steps.create-fine-reference.outputs.parameters.out-zarr }}"
                - name: qdm-kind
                  value: "{{ inputs.parameters.qdm-kind }}"
                - name: lat-slice-min
                  value: "{{ inputs.parameters.lat-slice-min}}"
                - name: lat-slice-max
                  value: "{{ inputs.parameters.lat-slice-max}}"
        - - name: apply-aiqpd
            template: apply-aiqpd
            arguments:
              parameters:
                - name: variable
                  value: "{{ inputs.parameters.variable-id }}"
                - name: simulation-zarr
                  value: "{{ inputs-parameters.simulation-zarr }}"
                - name: aiqpd-model-zarr
                  value: "{{ steps.train-aiqpd.outputs.parameters.out-zarr }}"
                - name: qdm-kind
                  value: "{{ inputs.parameters.qdm-kind }}"
                - name: lat-slice-min
                  value: "{{ inputs.parameters.lat-slice-min }}"
                - name: lat-slice-max
                  value: "{{ inputs.parameters.lat-slice-max }}"
                - name: out-zarr
                  value: "{{ inputs.parameters.out-zarr }}"


    - name: create-fine-reference
      inputs:
        parameters:
          - name: in-zarr
          - name: regrid-method
          - name: domain-file
      outputs:
        parameters:
          - name: out-zarr
            valueFrom:
              parameter: "{{ steps.move-chunks-to-space.outputs.parameters.out-zarr }}"
      steps:
        - - name: move-chunks-to-time
            template: rechunk
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ inputs.parameters.in-zarr }}"
                - name: time-chunk
                  value: "73"
                - name: lat-chunk
                  value: -1
                - name: lon-chunk
                  value: -1
        - - name: regrid
            template: regrid
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ steps.move-chunks-to-time.outputs.parameters.out-zarr }}"
                - name: regrid-method
                  value: "{{ inputs.parameters.regrid-method }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domain-file }}"
        - - name: move-chunks-to-space
            template: rechunk
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ steps.regrid.outputs.parameters.out-zarr }}"
                - name: time-chunk
                  value: 365
                - name: lat-chunk
                  value: 2
                - name: lon-chunk
                  value: -1


    - name: create-coarse-reference
      inputs:
        parameters:
          - name: in-zarr
          - name: regrid-method
          - name: domainfile0p25x0p25
          - name: domainfile1x1
      outputs:
        parameters:
          - name: out-zarr
            valueFrom:
              parameter: "{{ steps.move-chunks-to-space.outputs.parameters.out-zarr }}"
      steps:
        - - name: coarse-regrid
            template: regrid
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ inputs.parameters.in-zarr }}"
                - name: regrid-method
                  value: "{{ inputs.parameters.regrid-method }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domainfile1x1 }}"
        - - name: move-chunks-to-time
            template: rechunk
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ steps.coarse-regrid.outputs.parameters.out-zarr }}"
                - name: time-chunk
                  value: "73"
                - name: lat-chunk
                  value: -1
                - name: lon-chunk
                  value: -1
        - - name: fine-regrid
            template: regrid
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ steps.move-chunks-to-time.outputs.parameters.out-zarr }}"
                - name: regrid-method
                  value: "{{ inputs.parameters.regrid-method }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domainfile0p25x0p25 }}"
        - - name: move-chunks-to-space
            template: rechunk
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ steps.fine-regrid.outputs.parameters.out-zarr }}"
                - name: time-chunk
                  value: 365
                - name: lat-chunk
                  value: 2
                - name: lon-chunk
                  value: -1


    - name: preprocess-biascorrected
      inputs:
        parameters:
          - name: in-zarr
          - name: regrid-method
            value: "nearest_s2d"
          - name: domain-file
      outputs:
        parameters:
          - name: out-zarr
            valueFrom:
              parameter: "{{ steps.regrid.outputs.parameters.out-zarr }}"
      steps:
        - - name: move-chunks-to-time
            template: rechunk
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ inputs.parameters.in-zarr }}"
                - name: time-chunk
                  value: "73"
                - name: lat-chunk
                  value: -1
                - name: lon-chunk
                  value: -1
        - - name: regrid
            template: distributed-regrid
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ steps.move-chunks-to-time.outputs.parameters.out-zarr }}"
                - name: regrid-method
                  value: "{{ inputs.parameters.regrid-method }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domain-file }}"
                - name: add-cyclic-lon
                  value: "true"


    - name: regrid
      inputs:
        parameters:
          - name: in-zarr
          - name: out-zarr
            value: "az://scratch/{{ workflow.name }}/{{ pod.name }}/regridded.zarr"
          - name: regrid-method
          - name: domain-file
      outputs:
        parameters:
          - name: out-zarr
            value: "{{ inputs.parameters.out-zarr }}"
      container:
        image: downscalecmip6.azurecr.io/dodola:0.5.0
        env:
          - name: AZURE_STORAGE_ACCOUNT_NAME
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestorageaccount
          - name: AZURE_STORAGE_ACCOUNT_KEY
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestoragekey
        command: [ "dodola" ]
        args:
          - "regrid"
          - "{{ inputs.parameters.in-zarr }}"
          - "--astype=float32"
          - "--out"
          - "{{ inputs.parameters.out-zarr }}"
          - "--method"
          - "{{ inputs.parameters.regrid-method }}"
          - "--domain-file"
          - "{{ inputs.parameters.domain-file }}"
        resources:
          requests:
            memory: 48Gi
            cpu: "1000m"
          limits:
            memory: 48Gi
            cpu: "2000m"
      activeDeadlineSeconds: 3600
      retryStrategy:
        limit: 2
        retryPolicy: "Always"


    - name: rechunk
      inputs:
        parameters:
          - name: in-zarr
          - name: out-zarr
            value: "az://scratch/{{ workflow.name }}/{{ pod.name }}/rechunked.zarr"
          - name: time-chunk
            value: 365
          - name: lat-chunk
            value: 10
          - name: lon-chunk
            value: 10
          - name: time-dim-name
            value: time
      outputs:
        parameters:
          - name: out-zarr
            value: "{{ inputs.parameters.out-zarr }}"
      container:
        image: downscalecmip6.azurecr.io/dodola:0.5.0
        env:
          - name: AZURE_STORAGE_ACCOUNT_NAME
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestorageaccount
          - name: AZURE_STORAGE_ACCOUNT_KEY
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestoragekey
        command: [ dodola ]
        args:
          - "rechunk"
          - "{{ inputs.parameters.in-zarr }}"
          - "--out"
          - "{{ inputs.parameters.out-zarr }}"
          - "--chunk"
          - "{{ inputs.parameters.time-dim-name }}={{ inputs.parameters.time-chunk }}"
          - "--chunk"
          - "lat={{ inputs.parameters.lat-chunk }}"
          - "--chunk"
          - "lon={{ inputs.parameters.lon-chunk }}"
        resources:
          requests:
            memory: 48Gi
            cpu: "1000m"
          limits:
            memory: 48Gi
            cpu: "2000m"
      activeDeadlineSeconds: 1800
      retryStrategy:
        limit: 1
        retryPolicy: "Always"


    - name: train-aiqpd
      inputs:
        parameters:
          - name: coarse-reference-zarr
          - name: fine-reference-zarr
          - name: variable-id
          - name: qdm-kind
          - name: lat-slice-min
          - name: lat-slice-max
          - name: time-sel-start
            value: "1994-12-17"
          - name: time-sel-stop
            value: "2015-01-15"
          - name: out-zarr
            value: "az://scratch/{{ workflow.name }}/{{ pod.name }}/aiqpd-model.zarr"
      outputs:
        parameters:
          - name: out-zarr
            value: "{{ inputs.parameters.out-zarr }}"
      script:
        image: downscalecmip6.azurecr.io/dodola:0.6.0
        env:
          - name: AZURE_STORAGE_ACCOUNT_NAME
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestorageaccount
          - name: AZURE_STORAGE_ACCOUNT_KEY
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestoragekey
        command: [ python ]
        source: |
          import os
          import dodola.repository
          from dodola.core import train_analogdownscaling

          kind_map = {"multiplicative": "*", "additive": "+"}

          cref_zarr = "{{ inputs.parameters.coarse-reference-zarr }}"
          fref_zarr = "{{ inputs.parameters.fine-reference-zarr }}"
          out_zarr = "{{ inputs.parameters.out-zarr }}"

          time_sel_start = "{{ inputs.parameters.time-sel-start }}"
          time_sel_stop = "{{ inputs.parameters.time-sel-stop }}"
          min_slice = int({{ inputs.parameters.lat-slice-min }})
          max_slice = int({{ inputs.parameters.lat-slice-max }})

          variable = "{{ inputs.parameters.variable-id }}"
          kind = kind_map["{{ inputs.parameters.qdm-kind }}"]

          latslice = slice(min_slice, max_slice)
          print(f"{latslice=}")  # DEBUG
          timeslice = slice(time_sel_start, time_sel_stop)
          print(f"{timeslice=}")  # DEBUG

          print(f"reading {cref_zarr}")
          creference = dodola.repository.read(cref_zarr)
          print(f"{creference=}")  # DEBUG
          creference = creference.sel(time=timeslice)
          creference = creference.isel(lat=latslice)
          print(f"{creference=}")  # DEBUG

          print(f"reading {fref_zarr}")
          freference = dodola.repository.read(fref_zarr)
          print(f"{freference=}")  # DEBUG
          freference = freference.sel(time=timeslice)
          freference = freference.isel(lat=latslice)
          print(f"{freference=}")  # DEBUG

          creference.load()
          freference.load()

          aiqpd = train_analogdownscaling(
              coarse_reference=creference,
              fine_reference=freference,
              variable=variable,
              kind=kind,
              quantiles_n=620,
              window_n=31,
          )

          print(f"{aiqpd.ds=}")  # DEBUG

          dodola.repository.write(out_zarr, aiqpd.ds)
          print(f"Output written to {out_zarr}")  # DEBUG
        resources:
          requests:
            memory: 12Gi
            cpu: "1000m"
          limits:
            memory: 12Gi
            cpu: "3000m"
      activeDeadlineSeconds: 600
      retryStrategy:
        limit: 2
        retryPolicy: "Always"
        backoff:
          duration: 30s
          factor: 2


    - name: apply-aiqpd
      inputs:
        parameters:
          - name: simulation-zarr
          - name: aiqpd-model-zarr
          - name: variable
          - name: qdm-kind
          - name: lat-slice-min
          - name: lat-slice-max
          - name: out-zarr
            value: "az://scratch/{{ workflow.name }}/{{ pod.name }}/aiqpd_adjusted.zarr"
      outputs:
        parameters:
          - name: lat-slice-min
            value: "{{ inputs.parameters.lat-slice-min }}"
          - name: lat-slice-max
            value: "{{ inputs.parameters.lat-slice-max }}"
          - name: out-zarr
            value: "{{ inputs.parameters.out-zarr }}"
      script:
        image: downscalecmip6.azurecr.io/dodola:0.6.0
        env:
          - name: AZURE_STORAGE_ACCOUNT_NAME
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestorageaccount
          - name: AZURE_STORAGE_ACCOUNT_KEY
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestoragekey
        command: [ python ]
        source: |
          import dodola.repository
          from dodola.core import adjust_analogdownscaling


          nonlat_variables = ["lon", "time"]
          kind_map = {"multiplicative": "*", "additive": "+"}

          sim_zarr = "{{ inputs.parameters.simulation-zarr }}"
          aiqpd_model_zarr = "{{ inputs.parameters.aiqpd-model-zarr }}"
          out_zarr = "{{ inputs.parameters.out-zarr }}"
          min_slice = int({{ inputs.parameters.lat-slice-min }})
          max_slice = int({{ inputs.parameters.lat-slice-max }})
          variable = "{{ inputs.parameters.variable }}"
          kind = kind_map["{{ inputs.parameters.qdm-kind }}"]

          latslice = slice(min_slice, max_slice)
          print(f"{latslice=}")  # DEBUG

          sim_ds = dodola.repository.read(sim_zarr).isel(lat=latslice)
          sim_ds = sim_ds.set_coords(["sim_q"])
          print(f"{sim_ds=}")  # DEBUG
          print("loading data...")
          sim_ds.load()
          print("data loaded")

          aiqpd_ds = dodola.repository.read(aiqpd_model_zarr)
          print(f"{aiqpd_ds=}")  # DEBUG
          print("loading data...")
          aiqpd_ds.load()
          print("data loaded")

          # zarr dimensions can be switched, and if dim order
          # is not lat, lon, dayofyear, quantile, cannot broadcast
          #aiqpd_ds = aiqpd_ds.transpose("lon", "lat", "dayofyear", "quantiles")  # OOM error?

          downscaled_ds = adjust_analogdownscaling(
              simulation=sim_ds,
              aiqpd=aiqpd_ds,
              variable=variable
          )

          downscaled_ds = downscaled_ds.reset_coords(["sim_q"], drop=True)
          if nonlat_variables:
              downscaled_ds = downscaled_ds.drop_vars(nonlat_variables)

          downscaled_ds = downscaled_ds.transpose("time", "lat", "lon")
          print(f"{downscaled_ds=}")  # DEBUG

          # Output to region of existing zarr store.
          downscaled_ds[[variable]].to_zarr(
              out_zarr,
              region={"lat": latslice},
              mode="a"
          )
          print(f"Output written to {out_zarr}")  # DEBUG
        resources:
          requests:
            memory: 24Gi
            cpu: "1000m"
          limits:
            memory: 24Gi
            cpu: "6000m"
      activeDeadlineSeconds: 900
      retryStrategy:
        limit: 2
        retryPolicy: "Always"
        backoff:
          duration: 30s
          factor: 2


    - name: distributed-regrid
      inputs:
        parameters:
          - name: in-zarr
          - name: regrid-method
          - name: domain-file
          - name: add-cyclic-lon
            value: "false"
          # Space delimited list of all variables/coords in "in-zarr" without need for time dimension.
          - name: nontime-variables
            value: "lat lon"
      outputs:
        parameters:
          - name: out-zarr
            valueFrom:
              parameter: "{{ steps.prime-regrid-zarr.outputs.parameters.out-zarr }}"
      steps:
        - - name: prime-regrid-zarr
            template: prime-regrid-zarr
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ inputs.parameters.in-zarr }}"
                - name: regrid-method
                  value: "{{ inputs.parameters.regrid-method }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domain-file }}"
                - name: nontime-variables
                  value: "{{ inputs.parameters.nontime-variables }}"
        - - name: regrid-year-to-primedzarr
            template: regrid-select-year-to-primedzarr
            arguments:
              parameters:
                - name: in-zarr
                  value: "{{ inputs.parameters.in-zarr }}"
                - name: out-zarr
                  value: "{{ steps.prime-regrid-zarr.outputs.parameters.out-zarr }}"
                - name: regrid-method
                  value: "{{ inputs.parameters.regrid-method }}"
                - name: domain-file
                  value: "{{ inputs.parameters.domain-file }}"
                - name: nontime-variables
                  value: "{{ inputs.parameters.nontime-variables }}"
                - name: select-year
                  value: "{{ item }}"
                - name: add-cyclic-lon
                  value: "{{ inputs.parameters.add-cyclic-lon }}"
            withSequence:
              start: "{{ steps.prime-regrid-zarr.outputs.parameters.firstyear }}"
              end: "{{ steps.prime-regrid-zarr.outputs.parameters.lastyear }}"


    # Sets up output zarr file and metadata without writing time-related data to the zarr store.
    - name: prime-regrid-zarr
      inputs:
        parameters:
          - name: in-zarr
          - name: regrid-method
          - name: domain-file
          - name: nontime-variables
            value: "lat lon"
          - name: out-zarr
            value: "az://scratch/{{ workflow.name }}/{{ pod.name }}/regridded.zarr"
      outputs:
        parameters:
          - name: out-zarr
            value: "{{ inputs.parameters.out-zarr }}"
          - name: firstyear
            valueFrom:
              path: "/tmp/firstyear.txt"
          - name: lastyear
            valueFrom:
              path: "/tmp/lastyear.txt"
      script:
        image: downscalecmip6.azurecr.io/dodola:0.5.0
        env:
          - name: IN_ZARR
            value: "{{ inputs.parameters.in-zarr }}"
          - name: OUT_ZARR
            value: "{{ inputs.parameters.out-zarr }}"
          - name: REGRID_METHOD
            value: "{{ inputs.parameters.regrid-method }}"
          - name: DOMAIN_FILE
            value: "{{ inputs.parameters.domain-file }}"
          - name: NONTIME_VARIABLES
            value: "{{ inputs.parameters.nontime-variables }}"
          - name: AZURE_STORAGE_ACCOUNT_NAME
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestorageaccount
          - name: AZURE_STORAGE_ACCOUNT_KEY
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestoragekey
        command: [ python ]
        source: |
          import os
          import dodola.repository
          from dodola.core import xesmf_regrid
          import xarray as xr

          in_zarr = os.environ["IN_ZARR"]
          out_zarr = os.environ["OUT_ZARR"]
          regrid_method = os.environ["REGRID_METHOD"]
          domain_file = os.environ["DOMAIN_FILE"]
          # Space-delim string of variables and coordinates that do use "time" dimension.
          non_time = os.environ["NONTIME_VARIABLES"].strip().rsplit()

          ds_in = dodola.repository.read(in_zarr)
          domain_fl = dodola.repository.read(domain_file)

          first_year = ds_in["time"].dt.year.min().item()
          last_year = ds_in["time"].dt.year.max().item()
          print(f"{first_year=}, {last_year=}")

          ds_out = xesmf_regrid(ds_in, domain_fl, regrid_method, astype="float32")
          ds_out = ds_out.chunk({"time": 365, "lat": 2, "lon": -1})

          print(f"{ds_out=}")  # DEBUG

          # Output metadata to Zarr store.
          ds_out.to_zarr(
              out_zarr,
              mode="w",
              compute=False,
              consolidated=True
          )

          print(f"{ds_out[non_time]=}")  # DEBUG

          # Append variables that do not depend on "time"
          if non_time:
              ds_out[non_time].to_zarr(
                  out_zarr,
                  mode="a",
                  compute=True,
                  consolidated=True
              )

          with open("/tmp/firstyear.txt", mode="w") as fl:
              fl.write(str(first_year))
          with open("/tmp/lastyear.txt", mode="w") as fl:
              fl.write(str(last_year))
        resources:
          requests:
            memory: 4Gi
            cpu: "1000m"
          limits:
            memory: 4Gi
            cpu: "1000m"
      activeDeadlineSeconds: 900
      retryStrategy:
        limit: 2
        retryPolicy: "Always"


    # Write select year of time-indexed data to a pre-primed zarr file.
    - name: regrid-select-year-to-primedzarr
      inputs:
        parameters:
          - name: in-zarr
          - name: select-year
          - name: regrid-method
          - name: domain-file
          - name: out-zarr
          - name: add-cyclic-lon
            value: "false"
          - name: nontime-variables
            value: "lat lon"
      outputs:
        parameters:
          - name: out-zarr
            value: "{{ inputs.parameters.out-zarr }}"
      script:
        image: downscalecmip6.azurecr.io/dodola:0.5.0
        env:
          - name: IN_ZARR
            value: "{{ inputs.parameters.in-zarr }}"
          - name: OUT_ZARR
            value: "{{ inputs.parameters.out-zarr }}"
          - name: SELTIME
            value: "{{ inputs.parameters.select-year }}"
          - name: REGRID_METHOD
            value: "{{ inputs.parameters.regrid-method }}"
          - name: DOMAIN_FILE
            value: "{{ inputs.parameters.domain-file }}"
          - name: NONTIME_VARIABLES
            value: "{{ inputs.parameters.nontime-variables }}"
          - name: ADD_CYCLIC_LON
            value: "{{ inputs.parameters.add-cyclic-lon }}"
          - name: AZURE_STORAGE_ACCOUNT_NAME
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestorageaccount
          - name: AZURE_STORAGE_ACCOUNT_KEY
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestoragekey
        command: [ python ]
        source: |
          import os
          import dodola.repository
          from dodola.core import xesmf_regrid
          import xarray as xr
          import numpy as np

          in_zarr = os.environ["IN_ZARR"]
          out_zarr = os.environ["OUT_ZARR"]
          sel_time = os.environ["SELTIME"]
          regrid_method = os.environ["REGRID_METHOD"]
          domain_file = os.environ["DOMAIN_FILE"]
          # Space-delim string of variables and coordinates that do use "time" dimension.
          # If data has something like `lat_b` or `height`, and you care about getting it in output,
          # those names need to be in this variable!
          # TODO: We could make this dynamically find non-time dependent variables/coord variables.
          non_time = os.environ["NONTIME_VARIABLES"].strip().rsplit()
          add_cyclic_lon =  os.environ["ADD_CYCLIC_LON"].lower() == "true"

          # Setup regrid calculation for a time range.
          # Clip out target year from input data. This is a mess because we need the matches AND their index along
          # time, given the full dataset so that we can write back to the correct region in the output zarr store.
          ds_in = dodola.repository.read(in_zarr)

          ds_in = ds_in.sel(time=sel_time)
          ds_in.load()
          domain_fl = dodola.repository.read(domain_file)
          domain_fl.load()

          if add_cyclic_lon:
              ds_out = xesmf_regrid(ds_in, domain_fl, regrid_method, astype="float32", add_cyclic="lon")
          else:
              ds_out = xesmf_regrid(ds_in, domain_fl, regrid_method, astype="float32")

          ds_out = ds_out.chunk({"time": 365, "lat": 2, "lon": -1})

          with xr.open_zarr(out_zarr) as out_store:
              target_idx_slice = out_store["time"].to_index().get_loc(sel_time)

          if non_time:
              ds_out = ds_out.drop_vars(non_time)

          # Write to isolated region of Zarr store so can be done by independent processes.
          ds_out.to_zarr(out_zarr, region={"time": target_idx_slice}, mode="a")
        resources:
          requests:
            memory: 16Gi
            cpu: "1000m"
          limits:
            memory: 16Gi
            cpu: "4000m"
      activeDeadlineSeconds: 900
      retryStrategy:
        limit: 2
        retryPolicy: "Always"
        backoff:
          duration: 30s
          factor: 2



    # Sets up output zarr file and metadata without writing time-related data to the zarr store.
    - name: prime-aiqpd-biascorrected-output-zarr
      inputs:
        parameters:
          - name: simulation-zarr
          - name: variable
          - name: out-zarr
            value: "az://scratch/{{ workflow.name }}/{{ pod.name }}/downscaled.zarr"
          - name: nonlat-variables
            value: "time lon"
      outputs:
        parameters:
          - name: out-zarr
            value: "{{ inputs.parameters.out-zarr }}"
      script:
        image: downscalecmip6.azurecr.io/dodola:0.5.0
        env:
          - name: AZURE_STORAGE_ACCOUNT_NAME
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestorageaccount
          - name: AZURE_STORAGE_ACCOUNT_KEY
            valueFrom:
              secretKeyRef:
                name: workerstoragecreds-secret
                key: azurestoragekey
        command: [ python ]
        source: |
          import dodola.repository
          import xarray as xr

          nonlat_variables = ["lon", "time"]

          simulation_zarr = "{{ inputs.parameters.simulation-zarr }}"
          variable = "{{ inputs.parameters.variable }}"
          out_zarr = "{{ inputs.parameters.out-zarr }}"

          ds_out = dodola.repository.read(simulation_zarr)[[variable]]
          print(f"{ds_out=}")  # DEBUG

          # Output metadata to Zarr store.
          ds_out.to_zarr(
              out_zarr,
              mode="w",
              compute=False,
              consolidated=True
          )

          # Append variables that do not depend on "lat"
          if nonlat_variables:
              print(f"{ds_out[nonlat_variables]=}")  # DEBUG
              ds_out[nonlat_variables].to_zarr(
                  out_zarr,
                  mode="a",
                  compute=True,
                  consolidated=True
              )
        resources:
          requests:
            memory: 4Gi
            cpu: "1000m"
          limits:
            memory: 4Gi
            cpu: "1000m"
      activeDeadlineSeconds: 900
      retryStrategy:
        limit: 2
        retryPolicy: "Always"
